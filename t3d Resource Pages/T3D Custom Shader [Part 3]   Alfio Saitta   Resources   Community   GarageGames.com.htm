<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- saved from url=(0057)http://www.garagegames.com/community/resources/view/20991 -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		
		<link rel="icon" href="http://static.garagegames.com/static/images/theme/favicon.ico" type="image/x-icon">
		<link rel="shortcut icon" href="http://static.garagegames.com/static/images/theme/favicon.ico" type="image/x-icon">
		<meta name="Description" content="In this third part, we will use a technique perhaps unusual to allow our object to receive the shadows of other objects.">
		<meta name="Keywords" content="torque powered, indie, independent game development community, marble blast, torque engine, think tanks">
		
        
				<title>T3D Custom Shader [Part 3] | Alfio Saitta | Resources | Community | GarageGames.com</title>		<link href="./T3D Custom Shader [Part 3]   Alfio Saitta   Resources   Community   GarageGames.com_files/ui.base.css" media="screen" rel="stylesheet" type="text/css">
<link href="./T3D Custom Shader [Part 3]   Alfio Saitta   Resources   Community   GarageGames.com_files/ui.theme.css" media="screen" rel="stylesheet" type="text/css">
<link href="./T3D Custom Shader [Part 3]   Alfio Saitta   Resources   Community   GarageGames.com_files/main.css" media="screen" rel="stylesheet" type="text/css">
<!--[if ie]> <link href="http://static.garagegames.com/static/styles/ie.css?rev=2" media="screen,print" rel="stylesheet" type="text/css" ><![endif]-->				<script type="text/javascript" src="./T3D Custom Shader [Part 3]   Alfio Saitta   Resources   Community   GarageGames.com_files/ping"></script><script type="text/javascript" src="./T3D Custom Shader [Part 3]   Alfio Saitta   Resources   Community   GarageGames.com_files/jquery.js"></script>
<script type="text/javascript" src="./T3D Custom Shader [Part 3]   Alfio Saitta   Resources   Community   GarageGames.com_files/jquery-ui.js"></script>
<script type="text/javascript" src="./T3D Custom Shader [Part 3]   Alfio Saitta   Resources   Community   GarageGames.com_files/plugins.js"></script>
<script type="text/javascript" src="./T3D Custom Shader [Part 3]   Alfio Saitta   Resources   Community   GarageGames.com_files/gg.js"></script>
<script type="text/javascript">
    //<!--

	$().ready(initStuff);
	
	function initStuff() {
		$('.relevantProductFilter').live('click', function(){
			var slug = $(this).val();
			if(slug != 0) {
				if($(this).is(':checked')) {
					window.location = "/community/resources/all/"+slug+",";
				} else {
					var products = "".replace(slug + ',','');
					window.location = "/community/resources/all/" + products;
				}
			} else {
				window.location = "/community/resources";
			}
		});
	
		$('#what-can-i-do-here-arrow').unbind('mouseup').qtip({
			content: {
				text: $('#actions-list-container').html(),
				title: {
					text: 'Actions',
					button: 'close'
				}
			},
			position: {
				corner: {
					target: 'bottomRight',
					tooltip: 'topRight'
				},
				adjust: {
					x: -12
				}
			},
			show: 'click',
			hide: 'unfocus',
			style: {
				width: 150,
				tip: true,
				name: 'gg'
			},
			api: {
				onHide: function() {
					this.elements.target.removeClass('ui-state-active');
				}
			}
		});

		$('#filter-action-arrow').unbind('mouseup').qtip({
			content: {
				text: $('#filter-action-container').html(),
				title: {
					text: 'Filters',
					button: 'close'
				}
			},
			position: {
				corner: {
					target: 'bottomRight',
					tooltip: 'topRight'
				},
				adjust: {
					x: -12
				}
			},
			show: 'click',
			hide: 'unfocus',
			style: {
				width: 200,
				tip: true,
				name: 'gg'
			},
			api: {
				onHide: function() {
					this.elements.target.removeClass('ui-state-active');
				}
			}
		});
	}
    //-->
</script>	<style type="text/css">.dp-cpp .datatypes { color: #2E8B57; font-weight: bold; }</style><style type="text/css">.dp-cpp .datatypes { color: #2E8B57; font-weight: bold; }</style><style type="text/css">.dp-cpp .datatypes { color: #2E8B57; font-weight: bold; }</style><style type="text/css">.dp-cpp .datatypes { color: #2E8B57; font-weight: bold; }</style><style type="text/css">.dp-cpp .datatypes { color: #2E8B57; font-weight: bold; }</style><style type="text/css">.dp-cpp .datatypes { color: #2E8B57; font-weight: bold; }</style><style type="text/css">.dp-cpp .datatypes { color: #2E8B57; font-weight: bold; }</style></head>
<body><div id="WzTtDiV" style="visibility: hidden; position: absolute; overflow-x: hidden; overflow-y: hidden; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; left: 0px; top: 0px; width: 0px; "></div>
		<script type="text/javascript" src="./T3D Custom Shader [Part 3]   Alfio Saitta   Resources   Community   GarageGames.com_files/wz_tooltip.js"></script>
<div id="container">
	<div id="header">
		<div id="header-left"></div>
		<div id="header-center">
			<a href="http://www.garagegames.com/" id="header-home-link">Game Development Tools and Software</a>
			<div id="menu_bar">
				<div id="breadcrumbs">
	</div>

<ul id="main-nav">
	<li class="stub" id="main-nav-home"><a href="http://www.garagegames.com/">Home</a></li><li class="main-nav" id="main-nav-products"><a href="http://www.garagegames.com/products/torque-3d">Engines</a><ul class="sub-nav" id="sub-menu-products"><li><a href="http://www.garagegames.com/products/torque-3d">Torque 3D</a></li><li><a href="http://www.garagegames.com/products/torque-2d">Torque 2D</a></li><li><a href="http://www.garagegames.com/products/torque-2d/iphone">iTorque 2D</a></li><li><a href="http://www.garagegames.com/products/torque-x">Torque X</a></li><li><a href="http://www.garagegames.com/products/consoles">For Consoles</a></li><li><a href="http://www.garagegames.com/products/education">Educational Use</a></li><li><a href="http://www.garagegames.com/best-of-torque/torque-3d">Made with Torque</a></li></ul></li><li class="main-nav" id="main-nav-addons"><a href="http://www.garagegames.com/products/browse">Add-ons</a><ul class="sub-nav" id="sub-menu-addons"><li><a href="http://www.garagegames.com/products/browse/genrekits">Genre Kits</a></li><li><a href="http://www.garagegames.com/products/browse/tools">Tools</a></li><li><a href="http://www.garagegames.com/products/browse/artpacks">Art Packs</a></li><li><a href="http://www.garagegames.com/products/browse/games">Games</a></li></ul></li><li class="main-nav" id="main-nav-community"><a href="http://www.garagegames.com/community">Community</a><ul class="sub-nav" id="sub-menu-community"><li><a href="http://www.garagegames.com/community">What's New</a></li><li><a href="http://www.garagegames.com/community/blogs">Blogs</a></li><li><a href="http://www.garagegames.com/community/resources">Resources</a></li><li><a href="http://www.garagegames.com/community/forums">Forums</a></li><li><a href="http://www.garagegames.com/best-of-torque/interviews">Dev&nbsp;Interviews</a></li></ul></li><li class="main-nav" id="main-nav-support"><a rel="nofollow" href="http://www.garagegames.com/support">Support</a><ul class="sub-nav" id="sub-menu-support"><li><a href="http://www.garagegames.com/documentation">Documentation</a></li><li><a rel="nofollow" href="http://www.garagegames.com/support/bugs">Submit Bugs</a></li><li><a rel="nofollow" href="http://www.garagegames.com/support/paid">Paid Support</a></li></ul></li><li class="main-nav" id="main-nav-company"><a rel="nofollow" href="http://www.garagegames.com/company">Company</a><ul class="sub-nav" id="sub-menu-company"><li><a rel="nofollow" href="http://www.garagegames.com/company">About Garage Games</a></li><li><a rel="nofollow" href="http://www.garagegames.com/company/employment">Employment</a></li><li><a rel="nofollow" href="http://www.garagegames.com/company/licensing">Licensing</a></li><li><a rel="nofollow" href="http://www.garagegames.com/FAQ">Licensing FAQ</a></li><li><a rel="nofollow" href="http://www.garagegames.com/company/feeds">RSS Feeds</a></li><li><a rel="nofollow" href="http://www.garagegames.com/company/logo-guidelines">Logo Guidelines</a></li><li><a rel="nofollow" href="http://www.garagegames.com/company/contact">Contact Us</a></li></ul></li></ul>				<div id="traceout"></div>
				<div class="clear"></div>
			</div>
		</div>
		<div id="header-right">
							<div id="header-welcome"><span>Welcome,</span> Bloodknight</div>
						<ul id="header-status">
				
		<li id="header-logout"><a rel="nofollow" href="https://www.garagegames.com/account/logout"><span></span>Logout</a></li>
	<li id="header-cart" style="width: 80px"><a rel="nofollow" href="https://www.garagegames.com/store" id="cartLink"><span></span>Cart <em id="cart-count">(0)</em></a></li>
	<li id="header-account"><a rel="nofollow" href="http://www.garagegames.com/account"><span></span>My Account</a>
		<ul class="myaccount-options">
			<li><a rel="nofollow" href="http://www.garagegames.com/account">My Products</a></li>
						<li><a rel="nofollow" href="http://www.garagegames.com/account/studio">My Studio</a></li>
						<li><a rel="nofollow" href="http://www.garagegames.com/account/profile/74950">My Profile</a></li>
			<li><a rel="nofollow" href="http://www.garagegames.com/account/settings">My Settings</a></li>
					</ul>
	</li>	
			</ul>
			<div id="search-container">
                <form action="" onsubmit="searchSubmit(); return false;" method="get" id="search" name="search_form">
                        <input type="text" name="q" id="top-keywords" class="formTip" value="" title="Search site" maxlength="255">
                        <input type="image" id="top-submit" onclick="searchSubmit(); return false;" src="./T3D Custom Shader [Part 3]   Alfio Saitta   Resources   Community   GarageGames.com_files/search-bar-main-btn.png" alt="Search">
                </form>
                
                <script type="text/javascript">
                function searchSubmit() {
                	var search = $('#top-keywords').val();
                	window.location = '/community/search#'+search;
                }
                </script>
			</div>
		</div>
	</div>
	<!-- /header -->
	<div id="console"></div>
	<div id="content">
		<div id="maincol">
						<!-- content --><div class="section-container ui-corner-all" id="communityshell">
	<div class="section-header">
		<h2 style="float: left;"><span style="display: none;">Game Development</span> Community</h2>
		<div class="section-banner">
			
		</div>
		<div class="section-buttons">
			<div id="search-bar-sub-left">
				<form action="http://www.garagegames.com/search/advanced" onsubmit="searchSubmit(); return false;" method="get">
																<input type="hidden" name="locations[]" value="resource">
										<input type="text" name="search" id="search-bar-sub-mid" class="formTip" value="" title="Search resources" maxlength="255">
					<input type="image" id="search-bar-sub-right" src="./T3D Custom Shader [Part 3]   Alfio Saitta   Resources   Community   GarageGames.com_files/search-bar-sub-right.png" alt="Search">
				</form>
				
				<script type="text/javascript">
                function searchSubmit() {
                	var search = $('#search-bar-sub-mid').val();
                	window.location = '/community/search#'+search;
                }
                </script>
			</div>
		</div>
		<div class="clear"></div>
	</div>
	<div class="section-tabs">
		<ul>
			<li><a class="" href="http://www.garagegames.com/community">What's New</a></li>
			<li><a class="" href="http://www.garagegames.com/community/blogs">Blogs</a></li>
			<li><a class="current" href="http://www.garagegames.com/community/resources">Resources</a></li>
			<li><a class="" href="http://www.garagegames.com/community/forums">Forums</a></li>
		</ul>
											<a href="http://www.garagegames.com/community/resources/view/20991#" onclick="return false;" rel="nofollow" id="what-can-i-do-here-arrow" class="button ui-state-default ui-corner-all">
							<span style="float: right; margin-top: 2px;" class="ui-icon ui-icon-circle-triangle-s">More actions</span>
							More
						</a>
						<a rel="nofollow" id="what-can-i-do-here" class="button ui-state-default ui-corner-all" href="http://www.garagegames.com/community/resources/add">
							Add a Resource
						</a>
												<a href="http://www.garagegames.com/community/resources/view/20991#" onclick="return false;" rel="nofollow" id="filter-action-arrow" class="button ui-state-default ui-corner-all">
				<span style="float: right; margin-top: 2px;" class="ui-icon ui-icon-circle-triangle-s">Filter</span>
				Filter
			</a>
				<div class="clear"></div>
	</div>
	<div class="section-content">
				
<div id="blog-container">
	<div id="blog-content">
						<h1>T3D Custom Shader [Part 3]</h1>
		<p class="date" style="margin-bottom: 5px;">
			by <a href="http://www.garagegames.com/account/profile/154909">Alfio Saitta</a>
			<strong>·</strong>
			05/04/2011 (11:12 am)			<strong>·</strong>
			0 comments
		</p>
		<div id="blogContent" class="type-resource">
			<div class="body">In this third part, we will use a technique perhaps unusual to allow our object to receive the shadows of other objects.<br>
<br>
In practice i will use the deferred rendering, along with the forward rendering, to determine the level of brightness of a specific pixel. To do this, i will use a single vector returned from the information of the LightInfo. More precisely, the attenuation vector.<br>
<br>
The first step is add to our CustomMaterial a new sampler. But this time will not be related to a bitmap texture, but to the lighting information. The T3D provides us with a screenspace map containing the information of the brightness of each pixel (<b>#lightinfo</b>).<br>
<br>
<div class="dp-highlighter"><div class="bar"><div class="tools"><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;ViewSource&#39;,this);return false;">view plain</a><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;PrintSource&#39;,this);return false;">print</a><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;About&#39;,this);return false;">?</a></div></div><ol start="1" class="dp-cpp"><li class="alt"><span><span>sampler[</span><span class="string">"lightInfoBuffer"</span><span>]&nbsp;=&nbsp;</span><span class="string">"#lightinfo"</span><span>;&nbsp;&nbsp;</span></span></li></ol></div><pre name="code" class="cpp" style="display: none; ">sampler["lightInfoBuffer"] = "#lightinfo";</pre><br>
As with any sampler, you will need to import it into our shader.<br>
<div class="dp-highlighter"><div class="bar"><div class="tools"><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;ViewSource&#39;,this);return false;">view plain</a><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;PrintSource&#39;,this);return false;">print</a><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;About&#39;,this);return false;">?</a></div></div><ol start="1" class="dp-cpp"><li class="alt"><span><span>uniform&nbsp;sampler&nbsp;lightInfoBuffer&nbsp;:&nbsp;</span><span class="keyword">register</span><span>(S3);&nbsp;&nbsp;</span></span></li></ol></div><pre name="code" class="cpp" style="display: none; ">uniform sampler lightInfoBuffer : register(S3);</pre><br>
But unlike other sampler, this is accompanied by a float4 vector, called rtParamsX, where X must be equal to the number of register used by the sampler. In our case... S3. <br>
So we must declare our rtParams, like this:<br>
<br>
<div class="dp-highlighter"><div class="bar"><div class="tools"><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;ViewSource&#39;,this);return false;">view plain</a><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;PrintSource&#39;,this);return false;">print</a><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;About&#39;,this);return false;">?</a></div></div><ol start="1" class="dp-cpp"><li class="alt"><span><span>uniform&nbsp;float4&nbsp;rtParams3&nbsp;:&nbsp;</span><span class="keyword">register</span><span>(C0);&nbsp;&nbsp;</span></span></li></ol></div><pre name="code" class="cpp" style="display: none; ">uniform float4 rtParams3 : register(C0);</pre><br>
Add this peace of code to the end of your PixelShader, before merging all value for the output:<br>
<div class="dp-highlighter"><div class="bar"><div class="tools"><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;ViewSource&#39;,this);return false;">view plain</a><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;PrintSource&#39;,this);return false;">print</a><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;About&#39;,this);return false;">?</a></div></div><ol start="1" class="dp-cpp"><li class="alt"><span><span class="comment">//---------------------------------------------------------------------------------</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Deferred&nbsp;RT&nbsp;Lighting</span><span>&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;<span class="comment">//---------------------------------------------------------------------------------</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;float2&nbsp;uvScene&nbsp;=&nbsp;IN.screenspacePos.xy&nbsp;/&nbsp;IN.screenspacePos.w;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;uvScene&nbsp;=&nbsp;(&nbsp;uvScene&nbsp;+&nbsp;1.0&nbsp;)&nbsp;/&nbsp;2.0;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;uvScene.y&nbsp;=&nbsp;1.0&nbsp;-&nbsp;uvScene.y;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;uvScene&nbsp;=&nbsp;(&nbsp;uvScene&nbsp;*&nbsp;rtParams3.zw&nbsp;)&nbsp;+&nbsp;rtParams3.xy;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;float3&nbsp;d_lightcolor;&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;<span class="datatypes">float</span><span>&nbsp;d_NL_Att;&nbsp;&nbsp;&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;<span class="datatypes">float</span><span>&nbsp;d_specular;&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;lightinfoUncondition(tex2D(lightInfoBuffer,&nbsp;uvScene),&nbsp;d_lightcolor,&nbsp;d_NL_Att,&nbsp;d_specular);&nbsp;&nbsp;&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;<span class="comment">//---------------------------------------------------------------------------------</span><span>&nbsp;&nbsp;</span></span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;&lt;-&nbsp;Deferred&nbsp;RT&nbsp;Lighting</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;<span class="comment">//---------------------------------------------------------------------------------</span><span>&nbsp;&nbsp;</span></span></li></ol></div><pre name="code" class="cpp" style="display: none; ">//---------------------------------------------------------------------------------
   // Deferred RT Lighting
   //---------------------------------------------------------------------------------

   float2 uvScene = IN.screenspacePos.xy / IN.screenspacePos.w;  
   uvScene = ( uvScene + 1.0 ) / 2.0;  
   uvScene.y = 1.0 - uvScene.y;  
   uvScene = ( uvScene * rtParams3.zw ) + rtParams3.xy;  
   float3 d_lightcolor;  
   float d_NL_Att;  
   float d_specular;
   lightinfoUncondition(tex2D(lightInfoBuffer, uvScene), d_lightcolor, d_NL_Att, d_specular);  

   //---------------------------------------------------------------------------------
   // &lt;- Deferred RT Lighting
   //---------------------------------------------------------------------------------</pre><br>
As you can see, in the RT Deferred Lighting, defines three new vectors. Containing respectively:<br>
<br>
<ul><li> d_lightcolor = THE PIXEL RGB LIGHTING COLOR</li><li> d_NL_Att = THE LIGHT ATTENUATION VALUE FOR THE CURRENT PIXEL</li><li> d_specular = THE SPEC POWER FOR THE CURRENT PIXEL</li></ul><br>
The value that we need, is the light attenuation value.<br>
<br>
<div class="dp-highlighter"><div class="bar"><div class="tools"><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;ViewSource&#39;,this);return false;">view plain</a><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;PrintSource&#39;,this);return false;">print</a><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;About&#39;,this);return false;">?</a></div></div><ol start="1" class="dp-cpp"><li class="alt"><span><span class="comment">//&nbsp;MERGE&nbsp;ALL&nbsp;ON&nbsp;THE&nbsp;FINAL&nbsp;RESULT</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;&nbsp;float4&nbsp;OutColor&nbsp;=&nbsp;0;&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;OutColor&nbsp;+=&nbsp;Ambient;&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;OutColor&nbsp;+=&nbsp;LightColor;&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;OutColor&nbsp;*=&nbsp;Diff&nbsp;+&nbsp;Specular;&nbsp;&nbsp;</span></li><li class=""><span>&nbsp;&nbsp;&nbsp;OutColor&nbsp;*=&nbsp;DotLN;&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;OutColor.xyz&nbsp;*=&nbsp;d_NL_Att;&nbsp;<span class="comment">//&nbsp;HERE&nbsp;IS&nbsp;THE&nbsp;ATTENUATION&nbsp;APPLIED&nbsp;TO&nbsp;THE&nbsp;FINAL&nbsp;RESULT</span><span>&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;</span></li><li class="alt"><span>&nbsp;&nbsp;&nbsp;<span class="keyword">return</span><span>&nbsp;hdrEncode(OutColor);&nbsp;&nbsp;</span></span></li><li class=""><span>&nbsp;&nbsp;</span></li><li class="alt"><span>}&nbsp;&nbsp;</span></li></ol></div><pre name="code" class="cpp" style="display: none; ">// MERGE ALL ON THE FINAL RESULT
   float4 OutColor = 0;
   OutColor += Ambient;
   OutColor += LightColor;
   OutColor *= Diff + Specular;
   OutColor *= DotLN;
   OutColor.xyz *= d_NL_Att; // HERE IS THE ATTENUATION APPLIED TO THE FINAL RESULT

   return hdrEncode(OutColor);

}</pre><br>
<br>
If you look the definition of the entire Deffered Lighting section, you'll notice that there require a vector on input "IN.screenspacePos". This vector must contain the position of the vertex. So in your struc you need to add a new vector of the type float4. Containing information about the location of the vertex.<br>
<br>
<div class="dp-highlighter"><div class="bar"><div class="tools"><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;ViewSource&#39;,this);return false;">view plain</a><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;PrintSource&#39;,this);return false;">print</a><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;About&#39;,this);return false;">?</a></div></div><ol start="1" class="dp-cpp"><li class="alt"><span><span>float4&nbsp;screenspacePos&nbsp;&nbsp;:&nbsp;TEXCOORD5;&nbsp;&nbsp;</span></span></li></ol></div><pre name="code" class="cpp" style="display: none; ">float4 screenspacePos  : TEXCOORD5;</pre><br>
and set this on vertex shader like:<br>
<br>
<div class="dp-highlighter"><div class="bar"><div class="tools"><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;ViewSource&#39;,this);return false;">view plain</a><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;PrintSource&#39;,this);return false;">print</a><a href="http://www.garagegames.com/community/resources/view/20991#" onclick="dp.sh.Toolbar.Command(&#39;About&#39;,this);return false;">?</a></div></div><ol start="1" class="dp-cpp"><li class="alt"><span><span>OUT.screenspacePos&nbsp;=&nbsp;OUT.Position;&nbsp;&nbsp;</span></span></li></ol></div><pre name="code" class="cpp" style="display: none; ">OUT.screenspacePos = OUT.Position;</pre><br>
<br>
The result<br>
<a rel="nofollow" href="http://img805.imageshack.us/img805/7218/screenshot00600002.png" target="_blank"><img src="./T3D Custom Shader [Part 3]   Alfio Saitta   Resources   Community   GarageGames.com_files/screenshot00600002.th.png" alt="img805.imageshack.us/img805/7218/screenshot00600002.th.png"></a></div>
		</div>
		<div class="clear"></div>
	</div>
	<div style="background: #EEE; border: 1px solid #CCC; padding: 5px; margin-top: 15px;">
		<div class="left" style="width: 184px; text-align: center;">
			<img class="profilepic" src="./T3D Custom Shader [Part 3]   Alfio Saitta   Resources   Community   GarageGames.com_files/154909.png" alt="Alfio Saitta&#39;s profile picture">
			<br>
			<a rel="Alfio Saitta" class="member button profile-link ui-state-default ui-corner-all" href="http://www.garagegames.com/account/miniprofile/accountID/154909" onclick="return false;">
	<span style="margin-right: 5px; float: left" class="torque-icon">Torque Owner</span>
	Alfio Saitta
</a>		</div>
		<div class="left" style="width: 340px; margin: 0 15px;">
			<h3 style="margin: 5px 0px;">About the author</h3>
			<p style="text-align: left;">
							</p>
		</div>
		<div class="left" style="width: 300px;">
			<h3 style="margin: 5px 0px;">Recent Blogs</h3>
							•&nbsp;<a href="http://www.garagegames.com/community/blogs/view/20990">T3D Custom Shader [Part 2]</a><br>							•&nbsp;<a href="http://www.garagegames.com/community/blogs/view/20989">T3D Custom Shader [Part 1]</a><br>					</div>
		<div class="clear"></div>
	</div>
	<div class="clear"></div>
</div>

<div id="page-turner" class="separator-950">
	<div class="right">
							<a href="http://www.garagegames.com/community/blogs/view/20995"><span class="right-arrow">Next</span>Next resource</a>
				
	</div>
	<div class="left">
							<a href="http://www.garagegames.com/community/blogs/view/20990"><span class="left-arrow">Prev</span>Previous resource</a>
			</div>
	<div class="center"><a href="http://www.garagegames.com/community/resources">More resources</a></div>
	<div class="clear"></div>
</div>

<div>
	<a name="comments"></a>
		<br>	<div class="clear"></div>
	<div style="text-align: center;">
									<a href="http://www.garagegames.com/community/resource/view/20991#comment_form">+Add a comment</a><p></p>
				<label style="margin-left: 25px;" for="notify-me"><input type="checkbox" name="notify-me" id="notify-me" onchange="GG.blogNotify(20991, 74950);">Notify me of new comments</label>
						</div>
	<div class="clear" style="margin: 10px;"></div>
	<div id="commentList">
									<div class="clear"></div>
	</div>
	<br>	<div class="clear"></div>
			<div id="commentForm" style="text-align: center;">
			<a name="comment_form" id="comment_form"></a>
							<form action="http://www.garagegames.com/community/resources/view/20991/0" method="post">
					<dl>
						
<dt id="body-label"><label for="formBody" class="required">Add Your Comment (<a href="http://www.garagegames.com/community/resources/view/20991#" onclick="return false;" id="ml-link">MarkupLite is enabled</a>)</label></dt>
<dd id="body-element">
<textarea name="body" id="formBody" rows="10" cols="120" class="big"></textarea></dd>					</dl>
					<div class="clear"></div>
					<div style="float: left; width: auto; margin-left: 42%; margin-top: 10px;">
						<div style="height: 0px; overflow: hidden;">
	<input type="submit" name="Post Comment" value="Post Comment">
</div>
<a href="http://www.garagegames.com/community/resources/view/20991#" onclick="$(this).closest(&#39;form&#39;).submit(); return false;" class="submit button ui-state-default ui-corner-all">Post Comment</a>					</div>
				</form>
				<div class="clear"></div>
				
					</div>
		<div class="clear"></div>
</div>		<div class="clear"></div>
	</div>
	<div class="section-footer"></div>
</div>

<div id="actions-list-container">
	<span id="actions-list">
		<a href="http://www.garagegames.com/community/blogs/add">Post a blog</a><br>
		<a href="http://www.garagegames.com/community/resources/add">Add a resource</a><br>
					<a href="http://www.garagegames.com/community/forums/new">Start a Thread</a><br>
			</span>
</div>

<div id="filter-action-container" style="display: none;">
	<span id="actions-list">
	<input type="checkbox" class="relevantProductFilter" value="0"> All Products<br>
		<input type="checkbox" class="relevantProductFilter" value="other"> 3rd Party Addons<br>
		<input type="checkbox" class="relevantProductFilter" value="itorque2d"> iTorque 2D<br>
		<input type="checkbox" class="relevantProductFilter" value="itorque3d"> iTorque 3D<br>
		<input type="checkbox" class="relevantProductFilter" value="tge"> TGE<br>
		<input type="checkbox" class="relevantProductFilter" value="tgea"> TGEA<br>
		<input type="checkbox" class="relevantProductFilter" value="torque3dpro"> Torque 3D Pro<br>
		<input type="checkbox" class="relevantProductFilter" value="torquex"> Torque X<br>
		</span>
</div>

<!-- /content -->
			<div class="clear"></div>
		</div>
	</div>
	<!-- /container -->
	<div class="clear"></div>
	<br>
	<div id="footer-links">
	<a href="http://www.garagegames.com/">Home</a>
	<a href="http://www.garagegames.com/products">Products</a>
	<a href="http://www.garagegames.com/community">Community</a>
	<a href="http://www.garagegames.com/support">Support</a>
	<a href="http://www.garagegames.com/company">Company</a>
</div>	<div id="footer">
		<p>Copyright © GarageGames.com 2000 - 2011 All Rights Reserved. <a href="http://www.garagegames.com/company/tos">Terms of Service</a> - <a href="http://www.garagegames.com/company/privacy">Privacy Policy</a></p>
			</div>
	<script type="text/javascript">
		var STATIC_HOST = 'http://static.garagegames.com';
	</script>
	<script type="text/javascript">
		var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
		document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
	</script><script src="./T3D Custom Shader [Part 3]   Alfio Saitta   Resources   Community   GarageGames.com_files/ga.js" type="text/javascript"></script>
	<script type="text/javascript">
				var pageTracker = _gat._getTracker('UA-6057184-2');
					pageTracker._trackPageview('/community/resource/view/20991');
				
	</script>
	<script type="text/javascript">
		$().ready(getTimezoneAjax);
		function getTimezoneAjax() {
			var d = new Date();
			var offset = d;
			var params = { timezone: offset };
			$.get('/index/settimezone', params);
		}
	</script>
</div>
<div id="supersecrethiddendiv"></div>
<script src="./T3D Custom Shader [Part 3]   Alfio Saitta   Resources   Community   GarageGames.com_files/cf_tools.min.js" async="true"></script><script type="text/javascript">
//<![CDATA[
window.__CF=window.__CF||{};window.__CF.u="/cdn-cgi/async/cf/uri/";window.__CF.p="bc/0638c741769f9452bad4820a60d326";window.__CF.o=1;window.__CF.c=1;(function(){var a=document,b=a.createElement("script");b.src="//ajax.cloudflare.com/cdn-cgi/nexp/v=918368360/cf_tools.min.js";b.setAttribute("async","true");a=a.getElementsByTagName("script");a=a[a.length-1];a.parentNode.insertBefore(b,a)})();
//]]>
</script>

<div id="fancy_overlay"></div><div id="fancy_wrap"><div class="fancy_loading" id="fancy_loading"><div></div></div><div id="fancy_outer"><div id="fancy_inner"><div id="fancy_close"></div><div id="fancy_bg"><div class="fancy_bg fancy_bg_n"></div><div class="fancy_bg fancy_bg_ne"></div><div class="fancy_bg fancy_bg_e"></div><div class="fancy_bg fancy_bg_se"></div><div class="fancy_bg fancy_bg_s"></div><div class="fancy_bg fancy_bg_sw"></div><div class="fancy_bg fancy_bg_w"></div><div class="fancy_bg fancy_bg_nw"></div></div><a href="javascript:;" id="fancy_left"><span class="fancy_ico" id="fancy_left_ico"></span></a><a href="javascript:;" id="fancy_right"><span class="fancy_ico" id="fancy_right_ico"></span></a><div id="fancy_content"></div><div id="fancy_title"><table cellspacing="0" cellpadding="0" border="0"><tbody><tr><td class="fancy_title" id="fancy_title_left"></td><td class="fancy_title" id="fancy_title_main"><div></div></td><td class="fancy_title" id="fancy_title_right"></td></tr></tbody></table></div></div></div></div></body></html>